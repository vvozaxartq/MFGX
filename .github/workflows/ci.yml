
name: AutoTestSystem - CI (build only)

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"
  workflow_dispatch:

permissions:
  contents: read

env:
  SOLUTION_FILE: AutoTestSystem.sln
  BUILD_CONFIGURATION: Release
  BUILD_PLATFORM: "Any CPU"   # è‹¥ä½ å°ˆæ¡ˆæ˜¯ x86ï¼Œæ”¹æˆ "x86"

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Restore NuGet packages
        shell: pwsh
        run: nuget restore "${{ env.SOLUTION_FILE }}" -NonInteractive

      # ðŸ” ç·¨ç¢¼ç¨½æ ¸ï¼šåƒ…è­¦å‘Šï¼Œä¸ä¸­æ–·ï¼›åªæŽƒ Git è¿½è¹¤çš„æª”æ¡ˆï¼Œä¸¦æŽ’é™¤å¸¸è¦‹å¤–éƒ¨/æš«å­˜è³‡æ–™å¤¾
      - name: Check file encodings (warn only; ignore packages/bin/obj/etc.)
        continue-on-error: true
        shell: pwsh
        run: |
          # 1) å–å‡ºæ‰€æœ‰ã€Œè¢« Git è¿½è¹¤ã€çš„æª”æ¡ˆï¼ˆé¿å…æŽƒåˆ°æœªè¿½è¹¤çš„ packages ç­‰ï¼‰
          $tracked = (git ls-files -z) -split "`0"

          # 2) è¦æª¢æŸ¥çš„å‰¯æª”åï¼ˆå¯ä¾éœ€æ±‚èª¿æ•´ï¼‰
          $exts = @(".cs",".csx",".json",".xml",".yml",".yaml",".config",".ini",".md",".txt")

          # 3) æŽ’é™¤çš„ç›®éŒ„ï¼ˆå‰å¾Œéƒ½è™•ç†æ–œç·šï¼Œè·¨å¹³å°å®‰å…¨ï¼‰
          $excludeDirs = @(
            "/packages/",
            "/.nuget/",
            "/.git/",
            "/.vs/",
            "/.github/",
            "/bin/",
            "/obj/"
          )

          # 4) ç¯©é¸ï¼šå‰¯æª”åç¬¦åˆï¼Œä¸”ä¸åœ¨æŽ’é™¤ç›®éŒ„
          $files = @()
          foreach ($path in $tracked) {
            if ([string]::IsNullOrWhiteSpace($path)) { continue }
            $lower = $path.ToLowerInvariant()

            # å‰¯æª”åéŽæ¿¾
            $hasExt = $exts | ForEach-Object { $lower.EndsWith($_) } | Where-Object { $_ } | Measure-Object
            if ($hasExt.Count -eq 0) { continue }

            # ç›®éŒ„æŽ’é™¤
            $isExcluded = $false
            foreach ($ex in $excludeDirs) {
              if ($lower.Contains($ex)) { $isExcluded = $true; break }
            }
            if ($isExcluded) { continue }

            # è½‰æˆçµ•å°è·¯å¾‘ä»¥ä¾›æª”æ¡ˆè®€å–
            $full = Join-Path -Path $PWD -ChildPath $path
            if (Test-Path -LiteralPath $full -PathType Leaf) { $files += $full }
          }

          # 5) æª¢æŸ¥ UTF-8ï¼ˆå…è¨±æœ‰ BOM / ç„¡ BOMï¼‰ï¼›åµæ¸¬ U+FFFD æˆ–å†ç·¨ç¢¼é•·åº¦ä¸ä¸€è‡´
          $bad = @()
          foreach ($f in $files) {
            try {
              $bytes = [System.IO.File]::ReadAllBytes($f)
              $text  = [System.Text.Encoding]::UTF8.GetString($bytes)

              # å‡ºç¾æ›¿ä»£å­—å…ƒ â†’ éž UTF-8 æˆ–è³‡æ–™æå£ž
              if ($text.Contains([char]0xFFFD)) {
                $bad += $f
                continue
              }

              # é‡æ–°ç·¨ç¢¼å›ž UTF-8ï¼Œæ¯”å°å­—ç¯€é•·åº¦ï¼ˆæŠ“ ANSI/æœ¬åœ°ç¢¼é é€ æˆçš„è§£ç¢¼èµ°æ¨£ï¼‰
              $reBytes = [System.Text.Encoding]::UTF8.GetBytes($text)
              if ($bytes.Length -ne $reBytes.Length) {
                $bad += $f
                continue
              }
            }
            catch {
              # ä»»ä½•ä¾‹å¤–éƒ½è¦–ç‚ºéž UTF-8
              $bad += $f
              continue
            }
          }

          # 6) è¼¸å‡ºè­¦å‘Šï¼ˆä¸çµæŸä»»å‹™ï¼‰
          if ($bad.Count -gt 0) {
            Write-Host "::warning::åµæ¸¬åˆ°éž UTF-8 æª”æ¡ˆï¼ˆå¯èƒ½ç‚º ANSIï¼æœ¬åœ°ç¢¼é ï¼‰ï¼š"
            $bad | ForEach-Object { 
              # è½‰ç›¸å°è·¯å¾‘è¼ƒå¥½çœ‹
              $rel = $_.Substring($PWD.Length).TrimStart('\','/')
              Write-Host "::warning::$rel" 
            }
            Write-Host "::warning::è«‹é‡æ–°ä»¥ UTF-8ï¼ˆå»ºè­° UTF-8 with BOMï¼‰å„²å­˜ä¸Šè¿°æª”æ¡ˆã€‚"
            Write-Host "::warning::VSï¼šFile â†’ Save As â†’ Save with Encoding â†’ UTF-8 (with signature)"
            Write-Host "::warning::VS Codeï¼šå³ä¸‹è§’æ”¹ UTF-8 â†’ Save with Encoding"
          } else {
            Write-Host "âœ… å…¨éƒ¨æª”æ¡ˆç‚º UTF-8ï¼ˆå«ç„¡ BOM æˆ–æœ‰ BOMï¼‰"
          }

      - name: Build (Release)
        shell: pwsh
        run: >
          msbuild "${{ env.SOLUTION_FILE }}" /m
          /p:Configuration="${{ env.BUILD_CONFIGURATION }}"
          /p:Platform="${{ env.BUILD_PLATFORM }}"
          /p:CodePage=65001
          /p:Utf8Output=true
